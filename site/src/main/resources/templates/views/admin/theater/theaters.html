<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Danh sách rạp</title>
  <th:block th:replace="~{fragments/general-admin :: admin-head-resources}"></th:block>
</head>
<body>
<div class="admin-container">
  <div th:replace="~{fragments/general-admin :: admin-menu}"></div>

  <main class="main-content">
    <header>
      <h1>Danh sách rạp</h1>
    </header>
    <!-- Search bar -->
    <div class="my-5">
      <form class="row g-3 align-items-end" method="get" th:action="@{/theaters}">

        <div class="col-md-4 col-sm-12">
          <label for="keyword" class="form-label">Tìm kiếm rạp</label>
          <input type="text" id="keyword" name="keyword" class="form-control" placeholder="Nhập từ khóa tìm kiếm...">
        </div>

        <div class="col-md-3 col-sm-6">
          <label for="provinces" class="form-label">Tỉnh</label>
          <select id="provinces" class="form-select" th:field="*{provinces}">
            <option value="">-- Chọn Tỉnh --</option>
            <option th:each="province : ${provinces}"
                    th:value="${province.provinceId}"
                    th:text="${province.provinceName}">
            </option>
          </select>
        </div>

        <div class="col-md-3 col-sm-6">
          <label for="wards" class="form-label">Xã</label>
          <select id="wards" class="form-select" th:field="*{wards}">
            <option value="">-- Chọn xã --</option>
            <option th:each="ward : ${wards}"
                    th:value="${ward.id}"
                    th:text="${ward.wardName}">
            </option>
          </select>
        </div>

        <div class="col-md-2 col-sm-12 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1">Tìm kiếm</button>
          <button type="button" id="btn-open-add-theater" class="btn btn-success flex-grow-1">
            Thêm rạp mới
          </button>
        </div>

      </form>
    </div>

    <!-- Table -->
    <div class="table-responsive bg-dark text-white rounded shadow-sm">
      <table class="table table-dark table-hover mb-0">
        <thead class="thead-light">
        <tr>
          <th style="width: 20%;">Tên rạp</th>
          <th style="width: 25%;">Địa chỉ</th>
          <th style="width: 10%;">Tên xã</th>
          <th style="width: 10%;">Tên huyện</th>
          <th style="width: 20%;">Rạp mặc định</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="theater : ${theaters}"
            th:data-theater-id="${theater.theaterId}"
            style="cursor: pointer;">
          <input type="hidden" th:value="${theater.theaterId}" />
          <td th:text="${theater.name}"></td>
          <td th:text="${theater.address}"></td>
          <td th:text="${theater.wardName}"></td>
          <td th:text="${theater.provinceName}"></td>
          <td><input type="checkbox" th:checked="${theater.defaultFlag}" disabled /></td>

        </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination and Row Info -->
    <div class="d-flex justify-content-between align-items-center mt-3 text-white-50">
      <div>
        Rows per page:
        <select class="form-select d-inline-block w-auto ms-2">
          <option>10</option>
          <option>25</option>
          <option>50</option>
        </select>
      </div>
      <div>
        <!--                <span th:text="'1-' + ${reservations.size()} + ' of ' + ${totalReservations}">1-10 of 12</span>-->
        <button class="btn btn-sm btn-outline-light ms-2">&lt;</button>
        <button class="btn btn-sm btn-outline-light ms-1">&gt;</button>
      </div>
    </div>
  </main>

</div>
<div id="modal-theater"></div>
<script>
  function initChoices(pulldownId, placeholderValue) {
    return new Choices(pulldownId, {
      searchEnabled: true,
      itemSelectText: '',
      placeholder: true,
      searchPlaceholderValue: placeholderValue,
    });
  }
  let provinceChoices;
  let wardChoices;
  document.addEventListener("DOMContentLoaded", function () {
    const provinceSelect = document.getElementById("provinces");
    const wardsSelect = document.getElementById("wards");

    // Init Choices
    provinceChoices = initChoices(provinceSelect, 'Tìm tỉnh...')
    wardChoices = initChoices(wardsSelect, 'Tìm xã...')

    provinceSelect.addEventListener("change", function () {
      const selectedProvinceId = this.value;
      if (wardChoices) {
        wardChoices.destroy();
      }

      wardsSelect.innerHTML = '<option value="">-- Chọn xã --</option>';

      if (selectedProvinceId) {
        fetch('/api/v1/admin/provinces/' + selectedProvinceId + "/wards")
                .then(response => response.json())
                .then(data => {
                  data.list.forEach(ward => {
                    const option = document.createElement("option");
                    option.value = ward.id;
                    option.text = ward.ward_name;
                    wardsSelect.appendChild(option);
                  });

                  initChoices(wardsSelect, 'Tìm xã...')
                })
                .catch(error => {
                  console.error('Error has occurred:', error);
                });
      }
    });
  });

  document.getElementById("btn-open-add-theater")?.addEventListener("click", function() {
    openTheaterModal("/views/admin/theaters/add-new");
  });

  document.querySelectorAll('tr[data-theater-id]').forEach(function(tr) {
    tr.addEventListener('click', function() {
      const id = this.getAttribute('data-theater-id');
      openTheaterModal('/views/admin/theaters/' + id);
    });
  });

  function openTheaterModal(url) {
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.text();
      })
      .then(html => {
        const modalContainer = document.getElementById("modal-theater");
        modalContainer.innerHTML = html;

        const modalElement = document.getElementById('addTheaterModal');
        const bsModal = new bootstrap.Modal(modalElement);
        bsModal.show();

        const provinceSelectForAdd = document.getElementById("provincesForAdd");
        const wardsSelectForAdd = document.getElementById("wardsForAdd");
        initChoices(provinceSelectForAdd, 'Tìm tỉnh...')
        initChoices(wardsSelectForAdd, 'Tìm xã...')

      })
      .catch(error => {
        console.error("Error loading modal:", error);
      });
  }
</script>
</body>
</html>